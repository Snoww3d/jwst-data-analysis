# Base Docker Compose configuration
# For development: docker compose up -d (auto-loads docker-compose.override.yml)
# For production: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Pinned image versions (update periodically):
#   mongo:8.0                        - MongoDB Community Server 8.0.x
#   squidfunk/mkdocs-material:9      - MkDocs Material theme 9.x
# To update: check Docker Hub for latest minor/patch, test locally, then commit.

services:
  mongodb:
    image: mongo:8.0
    container_name: jwst-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:?Set MONGO_ROOT_USERNAME in .env (see .env.example)}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:?Set MONGO_ROOT_PASSWORD in .env (see .env.example)}
    volumes:
      - mongodb_data:/data/db
    networks:
      - jwst-network
      - jwst-shared

  backend:
    build:
      context: ../backend/JwstDataAnalysis.API
      dockerfile: Dockerfile
    container_name: jwst-backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:5001:8080"
    environment:
      - MongoDB__ConnectionString=mongodb://${MONGO_ROOT_USERNAME:?Set MONGO_ROOT_USERNAME in .env}:${MONGO_ROOT_PASSWORD:?Set MONGO_ROOT_PASSWORD in .env}@mongodb:27017
      - MongoDB__DatabaseName=${MONGO_DATABASE:-jwst_data_analysis}
      - ProcessingEngine__BaseUrl=http://processing-engine:8000
      - Storage__BasePath=/app/data
      - Storage__Provider=${STORAGE_PROVIDER:-local}
      - Storage__S3__BucketName=${S3_BUCKET_NAME:-jwst-data}
      - Storage__S3__Endpoint=${S3_ENDPOINT:-http://seaweedfs-s3:8333}
      - Storage__S3__AccessKey=${S3_ACCESS_KEY:-}
      - Storage__S3__SecretKey=${S3_SECRET_KEY:-}
      - Storage__S3__ForcePathStyle=${S3_FORCE_PATH_STYLE:-true}
      - Storage__S3__PublicEndpoint=${S3_PUBLIC_ENDPOINT:-http://localhost:8333}
    volumes:
      - ../data:/app/data
    depends_on:
      mongodb:
        condition: service_started
    networks:
      - jwst-network

  processing-engine:
    build:
      context: ../processing-engine
      dockerfile: Dockerfile
    container_name: jwst-processing
    restart: unless-stopped
    environment:
      - PYTHONPATH=/app
      - MAST_DOWNLOAD_DIR=${MAST_DOWNLOAD_DIR:-/app/data/mast}
      - MAST_DOWNLOAD_TIMEOUT=${MAST_DOWNLOAD_TIMEOUT:-3600}
      - MAX_MOSAIC_OUTPUT_PIXELS=${MAX_MOSAIC_OUTPUT_PIXELS:-64000000}
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-local}
      - STORAGE_BASE_PATH=/app/data
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-jwst-data}
      - S3_ENDPOINT=${S3_ENDPOINT:-http://seaweedfs-s3:8333}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE:-true}
      - S3_PUBLIC_ENDPOINT=${S3_PUBLIC_ENDPOINT:-http://localhost:8333}
    volumes:
      - ../data:/app/data
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - jwst-network

  frontend:
    build:
      context: ../frontend/jwst-frontend
      dockerfile: Dockerfile.dev
    container_name: jwst-frontend
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:5001}
    depends_on:
      backend:
        condition: service_started
      processing-engine:
        condition: service_healthy
    networks:
      - jwst-network

  # SeaweedFS S3-compatible object storage (local development)
  # Only used when STORAGE_PROVIDER=s3. All four services use the same image.
  seaweedfs-master:
    image: chrislusf/seaweedfs:latest
    container_name: jwst-seaweedfs-master
    restart: unless-stopped
    command: "master -ip=seaweedfs-master -ip.bind=0.0.0.0"
    profiles:
      - s3
    networks:
      - jwst-network

  seaweedfs-volume:
    image: chrislusf/seaweedfs:latest
    container_name: jwst-seaweedfs-volume
    restart: unless-stopped
    command: "volume -mserver=seaweedfs-master:9333 -ip.bind=0.0.0.0 -port=8080"
    volumes:
      - seaweedfs_data:/data
    depends_on:
      - seaweedfs-master
    profiles:
      - s3
    networks:
      - jwst-network

  seaweedfs-filer:
    image: chrislusf/seaweedfs:latest
    container_name: jwst-seaweedfs-filer
    restart: unless-stopped
    command: "filer -master=seaweedfs-master:9333 -ip.bind=0.0.0.0"
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
    profiles:
      - s3
    networks:
      - jwst-network

  seaweedfs-s3:
    image: chrislusf/seaweedfs:latest
    container_name: jwst-seaweedfs-s3
    restart: unless-stopped
    command: "s3 -filer=seaweedfs-filer:8888 -ip.bind=0.0.0.0 -port=8333"
    ports:
      - "127.0.0.1:8333:8333"
    depends_on:
      - seaweedfs-filer
    profiles:
      - s3
    networks:
      - jwst-network

  docs:
    image: squidfunk/mkdocs-material:9
    container_name: jwst-docs
    restart: unless-stopped
    ports:
      - "127.0.0.1:8001:8000"
    volumes:
      - ../mkdocs.yml:/app/mkdocs.yml
      - ../docs:/app/docs
    working_dir: /app
    command: [ "serve", "--dev-addr=0.0.0.0:8000" ]
    networks:
      - jwst-network

volumes:
  mongodb_data:
  seaweedfs_data:

networks:
  jwst-network:
    driver: bridge
  jwst-shared:
    driver: bridge
    name: jwst-shared
