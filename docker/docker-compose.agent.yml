# Agent stack template — parameterized for multiple concurrent stacks
#
# Required environment variables (set by agent-stack.sh):
#   SOURCE_ROOT    - Absolute path to agent's worktree
#   DATA_DIR       - Absolute path to shared FITS data directory
#   FRONTEND_PORT  - Host port for frontend (e.g. 3001)
#   BACKEND_PORT   - Host port for backend (e.g. 5002)
#   MONGO_ROOT_USERNAME / MONGO_ROOT_PASSWORD - MongoDB credentials
#
# Usage (via agent-stack.sh — not directly):
#   COMPOSE_PROJECT_NAME=jwst-agent-claude docker compose -f docker-compose.agent.yml up -d
#
# For frontend-only mode (shares main backend):
#   COMPOSE_PROJECT_NAME=jwst-agent-codex docker compose -f docker-compose.agent.yml up -d frontend

services:
  backend:
    build:
      context: ${SOURCE_ROOT}/backend/JwstDataAnalysis.API
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "127.0.0.1:${BACKEND_PORT:?BACKEND_PORT required}:8080"
    environment:
      - MongoDB__ConnectionString=mongodb://${MONGO_ROOT_USERNAME:?}:${MONGO_ROOT_PASSWORD:?}@mongodb:27017
      - MongoDB__DatabaseName=${MONGO_DATABASE:-jwst_data_analysis}
      - ProcessingEngine__BaseUrl=http://processing-engine:8000
      - ASPNETCORE_ENVIRONMENT=Development
      - CORS_ALLOWED_ORIGINS=http://localhost:${FRONTEND_PORT}
    volumes:
      - ${DATA_DIR:?DATA_DIR required}:/app/data
    networks:
      - default
      - jwst-shared

  processing-engine:
    build:
      context: ${SOURCE_ROOT}/processing-engine
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - PYTHONPATH=/app
      - MAST_DOWNLOAD_DIR=${MAST_DOWNLOAD_DIR:-/app/data/mast}
      - MAST_DOWNLOAD_TIMEOUT=${MAST_DOWNLOAD_TIMEOUT:-3600}
      - MAX_MOSAIC_OUTPUT_PIXELS=${MAX_MOSAIC_OUTPUT_PIXELS:-64000000}
    volumes:
      - ${DATA_DIR:?DATA_DIR required}:/app/data
    networks:
      - default

  frontend:
    build:
      context: ${SOURCE_ROOT}/frontend/jwst-frontend
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    ports:
      - "127.0.0.1:${FRONTEND_PORT:?FRONTEND_PORT required}:3000"
    environment:
      - VITE_API_URL=http://localhost:${BACKEND_PORT}
    volumes:
      - ${SOURCE_ROOT}/frontend/jwst-frontend:/app
      - /app/node_modules
    networks:
      - default

networks:
  jwst-shared:
    external: true
    name: jwst-shared
