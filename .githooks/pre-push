#!/bin/bash
#
# Pre-push hook to prevent direct pushes to main branch.
# All changes must go through feature branches and PRs.
# Allows branch deletion (git push --delete) on any branch.
#
# Install with: ./scripts/setup-hooks.sh

protected_branch='main'
current_branch=$(git symbolic-ref HEAD 2>/dev/null | sed -e 's,.*/\(.*\),\1,')

# Allow branch deletion — read stdin for refspecs
while read local_ref local_sha remote_ref remote_sha; do
    # Deletion: local_ref is "(delete)" and local_sha is all zeros
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi

    # Block pushes to main
    if [ "$current_branch" = "$protected_branch" ]; then
        echo ""
        echo "⛔ ERROR: Direct push to '$protected_branch' is not allowed."
        echo ""
        echo "All changes must go through a feature branch and Pull Request."
        echo "Even for documentation-only fixes, create a branch first:"
        echo ""
        echo "  git checkout -b docs/your-change-name"
        echo "  git push -u origin docs/your-change-name"
        echo "  gh pr create"
        echo ""
        exit 1
    fi
done

exit 0
