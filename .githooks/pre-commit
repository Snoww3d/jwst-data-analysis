#!/bin/bash
#
# Pre-commit hook to run linting, formatting, and tests before committing.
# This ensures code quality issues are caught locally before pushing to CI.
#
# Install with: ./scripts/setup-hooks.sh
#
# What this hook checks:
# - Frontend: ESLint, Prettier, Unit Tests (if frontend files changed)
# - Backend: dotnet build (if backend files changed)
# - Processing Engine: Ruff lint and format (if Python files changed)
#

set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any files in a directory are staged
has_staged_files_in() {
    echo "$STAGED_FILES" | grep -q "^$1" 2>/dev/null
}

# Track if any checks failed
FAILED=0

echo ""
echo "üîç Running pre-commit checks..."
echo ""

# ============================================
# Frontend Checks (if frontend files changed)
# ============================================
if has_staged_files_in "frontend/jwst-frontend/"; then
    echo -e "${YELLOW}üì¶ Frontend changes detected - running checks...${NC}"

    cd "$REPO_ROOT/frontend/jwst-frontend"

    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo -e "${RED}‚ùå node_modules not found. Run 'npm install' first.${NC}"
        FAILED=1
    else
        # ESLint
        echo "  ‚Üí Running ESLint..."
        if ! npm run lint --silent 2>/dev/null; then
            echo -e "${RED}  ‚ùå ESLint found errors${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì ESLint passed${NC}"
        fi

        # Prettier
        echo "  ‚Üí Checking Prettier formatting..."
        if ! npm run format:check --silent 2>/dev/null; then
            echo -e "${RED}  ‚ùå Prettier formatting issues found${NC}"
            echo -e "${YELLOW}     Run 'npm run format' to fix${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì Prettier passed${NC}"
        fi

        # Unit Tests
        echo "  ‚Üí Running unit tests..."
        if ! npm test --silent 2>/dev/null; then
            echo -e "${RED}  ‚ùå Unit tests failed${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì Unit tests passed${NC}"
        fi
    fi

    cd "$REPO_ROOT"
    echo ""
fi

# ============================================
# Backend Checks (if backend files changed)
# ============================================
if has_staged_files_in "backend/"; then
    echo -e "${YELLOW}üì¶ Backend changes detected - running checks...${NC}"

    # Check if dotnet is available
    if command -v dotnet &> /dev/null; then
        echo "  ‚Üí Building backend..."
        if ! dotnet build "$REPO_ROOT/backend/JwstDataAnalysis.sln" --verbosity quiet 2>/dev/null; then
            echo -e "${RED}  ‚ùå Backend build failed${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì Backend build passed${NC}"
        fi

        echo "  ‚Üí Running backend tests..."
        if ! dotnet test "$REPO_ROOT/backend/JwstDataAnalysis.API.Tests" --verbosity quiet --no-build 2>/dev/null; then
            echo -e "${RED}  ‚ùå Backend tests failed${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì Backend tests passed${NC}"
        fi
    else
        echo -e "${YELLOW}  ‚ö† dotnet not found - skipping backend checks${NC}"
    fi

    echo ""
fi

# ============================================
# Processing Engine Checks (if Python files changed)
# ============================================
if has_staged_files_in "processing-engine/"; then
    echo -e "${YELLOW}üì¶ Processing engine changes detected - running checks...${NC}"

    cd "$REPO_ROOT/processing-engine"

    # Check if ruff is available
    if command -v ruff &> /dev/null; then
        echo "  ‚Üí Running Ruff lint..."
        if ! ruff check . --quiet 2>/dev/null; then
            echo -e "${RED}  ‚ùå Ruff lint found errors${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì Ruff lint passed${NC}"
        fi

        echo "  ‚Üí Checking Ruff formatting..."
        if ! ruff format --check . --quiet 2>/dev/null; then
            echo -e "${RED}  ‚ùå Ruff formatting issues found${NC}"
            echo -e "${YELLOW}     Run 'ruff format .' to fix${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì Ruff format passed${NC}"
        fi
    else
        echo -e "${YELLOW}  ‚ö† ruff not found - skipping Python checks${NC}"
    fi

    cd "$REPO_ROOT"
    echo ""
fi

# ============================================
# Final Result
# ============================================
if [ $FAILED -ne 0 ]; then
    echo -e "${RED}‚ùå Pre-commit checks failed!${NC}"
    echo ""
    echo "Fix the issues above and try again."
    echo "To skip this hook (not recommended): git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo ""
exit 0
